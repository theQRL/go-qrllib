name: Security

on: [push, pull_request]

permissions:
  contents: read

jobs:
  govulncheck:
    name: govulncheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24.x'
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - name: Run govulncheck
        run: govulncheck ./...

  gosec:
    name: gosec
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24.x'
      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest
      - name: Run gosec
        # -tests=false: exclude test files (G404 weak RNG is acceptable in tests)
        # -exclude=G602,G115: exclude false positives in crypto code where bounds/overflow
        #   are mathematically guaranteed by algorithm constraints
        run: gosec -exclude-dir=.github -tests=false -exclude=G602,G115 ./...

  nancy:
    name: nancy
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_NANCY == 'true' }}
    steps:
      - uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24.x'
      - name: Install nancy
        run: go install github.com/sonatype-nexus-community/nancy@latest
      - name: Run nancy
        run: go list -json -deps ./... | nancy sleuth
        env:
          OSSI_USERNAME: ${{ secrets.OSSI_USERNAME }}
          OSSI_TOKEN: ${{ secrets.OSSI_TOKEN }}
